<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>glock demo</title>
  </head>
  <body>
    <video
      id="videoElement"
      src="video.mp4"
      loop
      autoplay
      preload="auto"
      playsinline
      style="width: 640px; height: 360px"
    ></video>
    <br />
    <button id="connectBtn">Connect</button>
    <button id="startBtn" disabled>Start</button>
    <button id="stopBtn" disabled>Stop</button>
    <button id="disconnectBtn" disabled>Disconnect</button>

    <script type="module">
      import Client from "../dist/client.js";

      const videoElement = document.getElementById("videoElement");
      const connectBtn = document.getElementById("connectBtn");
      const disconnectBtn = document.getElementById("disconnectBtn");
      const startBtn = document.getElementById("startBtn");
      const stopBtn = document.getElementById("stopBtn");

      let client;

      connectBtn.addEventListener("click", async () => {
        connectBtn.disabled = true;

        // Capture stream from video element
        const stream = videoElement.captureStream(30);

        // Replace with your actual WebSocket server URL and auth key
        client = new Client("ws://localhost:8080", stream, {
          debug: false,
          authKey: "your-secret-auth-key",
        });

        await client.connect().then(() => {
          disconnectBtn.disabled = false;
          startBtn.disabled = false;
        });

        client.addEventListener("avStreamStartError", () => {
          startBtn.disabled = false;
          stopBtn.disabled = true;
          videoElement.pause();
        });
      });

      startBtn.addEventListener("click", () => {
        startBtn.disabled = true;
        stopBtn.disabled = false;

        client.start({
          destination: {
            type: "file",
            path: "output.mp4",
          },
          chunkLengthTime: 500,
          processor: "ffmpeg",
        });

        videoElement.play();
      });

      stopBtn.addEventListener("click", () => {
        startBtn.disabled = false;
        stopBtn.disabled = true;

        client.stop();
        videoElement.pause();
      });

      disconnectBtn.addEventListener("click", () => {
        if (client) {
          client.disconnect();
          connectBtn.disabled = false;
          disconnectBtn.disabled = true;
          startBtn.disabled = true;
          stopBtn.disabled = true;
          videoElement.pause();
        }
      });
    </script>
  </body>
</html>
